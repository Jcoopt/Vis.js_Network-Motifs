<!doctype html>
<html>
<head>
    <title>Upload new File</title>
    <style type="text/css">
            body {
              font: 10pt sans;
            }
            #network {
                float:left;
                width: 600px;
                height: 600px;
                margin:5px;
                border: 1px solid lightgray;
            }
            #config {
                float:left;
                width: 400px;
                height: 600px;
            }
            #input_output {
                height: 10%;
                width: 15%;
            }
            p {
                font-size:16px;
                max-width:700px;
            }
        </style>
    <script type="text/javascript" src="http://visjs.org/dist/vis.js"></script>
    <script type="text/javascript" src="http://visjs.org/examples/network/exampleUtil.js"></script>
    <link href="http://visjs.org/dist/vis-network.min.css" rel="stylesheet" type="text/css"/>

</head>
<body>
    <p> {{graph}}</p>
    <p></p>
    <p></p>

    <div id="network"></div>



        <script type="text/javascript">
            //built upon code used from http://visjs.org/examples/network/other/saveAndLoad.html
            	var network;
            	var container;
            	var exportArea;
        	    var importButton;
         	    var exportButton;
         	    var nodes;
         	    var edges;
         	    var data;

            	function init() {
                	container = document.getElementById('network');
                	exportArea = document.getElementById('input_output');
                	importButton = document.getElementById('import_button');
                	exportButton = document.getElementById('export_button');

                	draw();
                	console.log('init')
                	console.log(typeof nodes)
            	}



            	function addConnections(elem, index) {
                        // need to replace this with a tree of the network, then get child direct children of the element
                        elem.connections = network.getConnectedNodes(index);

                    }

                function destroyNetwork() {
                        network.destroy();
                    }

                function clearOutputArea() {
                        exportArea.value = "";
                    }



                function download(filename, text) {
              		var element = document.createElement('a');
              		element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
              		element.setAttribute('download', filename);

              		element.style.display = 'none';
              		document.body.appendChild(element);

              		element.click();

              		document.body.removeChild(element);
            	}


            	function draw() {
            	    var nodes_import =JSON.parse('{{ nodes | tojson | safe}}');
            	    //console.log(importData);
                	// create a network of nodes with a function

                    var nodes = new vis.DataSet()
                    for (var key in nodes_import) {
                        if (nodes_import.hasOwnProperty(key)) {
                            console.log(key + " -> " + nodes_import[key]);
                            nodes.add({id:nodes_import[key]["id"],label:nodes_import[key]["label"]});

                        }
                    }
                    var edges_import =JSON.parse('{{ edges | tojson | safe}}');
            	    //console.log(importData);
                	// create a network of nodes with a function

                    var edges = new vis.DataSet()
                    for (var id in edges_import) {
                        if (edges_import.hasOwnProperty(id)) {
                            console.log(id + "edge -> " + edges_import[id]);
                            edges.add({from:edges_import[id][0],to:edges_import[id][1],arrows:'from'});

                        }
                    }

                	//var data = getScaleFreeNetwork(5);
                	//var data = getScaleFreeNetwork(5);

                	//No data has been passed, so create a hard coded network
                    if (nodes == undefined){
                       nodes = new vis.DataSet([
                        {id: 1, label: 'Node 1'},
                        {id: 2, label: 'Node 2'},
                        {id: 3, label: 'Node 3'},
                        {id: 4, label: 'Node 4'},
                        {id: 5, label: 'Node 5'},
                        {id: 6, label: 'Node 6'},
                        {id: 7, label: 'Node 7'},
                        {id: 8, label: 'Node 8'}
                      ]);

                      // create an array with edges
                      edges = new vis.DataSet([
                        {from: 1, to: 8, arrows:'to'},
                        {from: 1, to: 3, arrows:'to'},
                        {from: 1, to: 2, arrows:'to, from'},
                        {from: 2, to: 4, arrows:'to'},
                        {from: 2, to: 5, arrows:'to, from'},
                        {from: 5, to: 6, arrows:'to'},
                        {from: 6, to: 7, arrows:'from'}               ]);
                    }
                    console.log('draw');
                    console.log(nodes)
                    console.log(nodes.get());

                      // create a network
                      var container = document.getElementById('network');
                      var data = {
                        nodes: nodes,
                        edges: edges
                      };

                      var options = {};
                	network = new vis.Network(container, data, {manipulation:{enabled:false}});

                	clearOutputArea();
                	return nodes//, edges
            	}


            	function exportNetwork() {
                	clearOutputArea();
                	console.log(nodes.get());
                	console.log(edges.get());

                    var exportData = {}

                    exportData['nodes']=nodes.get()
                    exportData['edges']=edges.get()
                    console.log(exportData);
                    var exportValue = JSON.stringify(exportData);
                	console.log(exportValue);

			        download("filename.json", exportValue);

                   exportArea.value = exportValue;

                	resizeExportArea();
            	}

            	function importNetwork(fileValue) {

                	if (fileValue == "import"){
				        var inputValue = exportArea.value;
			         }

                    else{
				        var inputValue=fileValue;
			        }

			        console.log(inputValue);
                    var inputData = JSON.parse(inputValue);
                    console.log(inputData)
                    nodes = new vis.DataSet(inputData['nodes'])
                    edges = new vis.DataSet(inputData['edges'])

                    draw()

            	    }

                function getNodeData(data) {
                	var networkNodes = [];

                	data.forEach(function(elem, index, array) {
                    	networkNodes.push({id: elem.id, label: elem.id, x: elem.x, y: elem.y});
                	});

                	return new vis.DataSet(networkNodes);
            	}

            	function getNodeById(data, id) {
                	for (var n = 0; n < data.length; n++) {
                    		if (data[n].id == id) {  // double equals since id can be numeric or string
                      			return data[n];
                    		}
                	};

                	throw 'Can not find id \'' + id + '\' in data';
            	}

            	function getEdgeData(data) {
                	var networkEdges = [];

                	data.forEach(function(node) {
                    		// add the connection
                    		node.connections.forEach(function(connId, cIndex, conns) {
                        		networkEdges.push({from: node.id, to: connId});
                        		let cNode = getNodeById(data, connId);

                        		var elementConnections = cNode.connections;

                        		// remove the connection from the other node to prevent duplicate connections
                        		var duplicateIndex = elementConnections.findIndex(function(connection) {
                          			return connection == node.id; // double equals since id can be numeric or string
                        		});


                        		if (duplicateIndex != -1) {
                          			elementConnections.splice(duplicateIndex, 1);
                        		};
                  		});
                	});

                    return new vis.DataSet(networkEdges);
               }

                function objectToArray(obj) {
                    return Object.keys(obj).map(function (key) {
                      obj[key].id = key;
                      return obj[key];
                    });
                }

                function resizeExportArea() {
                    exportArea.style.height = (1 + exportArea.scrollHeight) + "px";
                }

            init();
        </script>

    <p></p>
    <div id ="stats" style="clear: both;">
    {% for stat in stats %}

        {% for s in stat %}

            <p>{{s}}</p>
    {% endfor %}
    {% endfor %}
    </div>
</body>
</html>
